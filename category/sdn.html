<!DOCTYPE html>
<html lang="zh"
>
<head>
    <title>SDN - YsY记录点滴</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




    <meta name="author" content="yansy" />
    <meta name="keywords" content="SDN" />

    <!-- Open Graph tags -->
        <meta property="og:site_name" content="YsY记录点滴" />
        <meta property="og:type" content="website"/>
        <meta property="og:title" content="YsY记录点滴"/>
        <meta property="og:url" content="http://ysywh.github.io"/>
        <meta property="og:description" content="YsY记录点滴"/>


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://ysywh.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://ysywh.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://ysywh.github.io/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://ysywh.github.io/theme/css/style.css" type="text/css"/>

        <link href="http://ysywh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="YsY记录点滴 ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://ysywh.github.io/" class="navbar-brand">
YsY记录点滴            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="http://github.com">ITEM1</a></li>
                    <li><a href="URL">ITEM2</a></li>
                         <li><a href="http://ysywh.github.io/pages/About me.html">
                             About Me
                          </a></li>
                        <li >
                            <a href="http://ysywh.github.io/category/hadoop.html">Hadoop</a>
                        </li>
                        <li >
                            <a href="http://ysywh.github.io/category/program.html">Program</a>
                        </li>
                        <li class="active">
                            <a href="http://ysywh.github.io/category/sdn.html">Sdn</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://ysywh.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

            <article>
                <h2><a href="http://ysywh.github.io/pages/2015/07/22/Ryu代码分析----openflow消息属性分析.html">Ryu代码分析----openflow消息属性分析</a></h2>
                <div class="summary"><h3>前言</h3>
<p>当从交换机接收到openflow消息，我们暂且称为msg， 这个msg实体中有很多属性，分两种：</p>
<ul>
<li>
<p>msg继承自基类MsgBase的基本属性：datapath，version，msg_type，msg_len，xid，buf 等</p>
</li>
<li>
<p>每种openflow消息自己的属性。比如packetin消息，具有match,data（数据层面的传统数据包的全部内容或是只是报头内容）等属性。 </p>
</li>
</ul>
<p>当我们 openflow消息，需要对消息msg进行解析，甚至是构造openflow消息发送出去。这些消息都是由属性成员构成，因此对其属性进行分析极其重要。</p>
<p>packetin消息是一个极其重要的openflow消息，它具有如下属性。flowmod属性中也有match属性，还有instruction属性，packet-out中还有actions属性。本位对这些重要属性进行解析。</p>
<p>Packet-in消息属性：</p>
<div class="highlight"><pre>buffer_id     ID assigned by datapath
total_len     Full length of frame
reason        Reason packet is being sent.

              | OFPR_NO_MATCH
              | OFPR_ACTION ...</pre></div>
                    <a class="btn btn-default btn-xs" href="http://ysywh.github.io/pages/2015/07/22/Ryu代码分析----openflow消息属性分析.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="http://ysywh.github.io/pages/2015/07/10/Ryu源码分析.html">Ryu源码分析</a></h2>
                <div class="summary"><p>Ryu是一个Python写的轻量级控制器，具有易于学习实现的优点。使用ryu进行app开发，有必要对以下几个概念做基本了解：</p>
<h4>1 Event类</h4>
<p>位置：ryu\lib\alert.py中Event类</p>
<p>有一些属性，比如datapath，msg等。其中，datapath是接收到openflow消息的交换机实体，msg就是openflow消息实体。</p>
<h3>2 讯息实体msg的类：MsgBase()类（讯息实体的基本类）</h3>
<p>位置：ryu\ofproto\ofproto_parser中 MsgBase()类，</p>
<p>属性：datapath，version，msg_type，msg_len，xid，buf 等，属于所有讯息实体msg的基本属性。此类会被其他产生讯息的类继承。</p>
<p>比如packetin消息，会继承这些基本属性外，还具体自己的属性，如match,data等。</p>
<h3>3 datapath</h3>
<p>类位置：ryu\controller\controller.py中 ...</p>
                    <a class="btn btn-default btn-xs" href="http://ysywh.github.io/pages/2015/07/10/Ryu源码分析.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="http://ysywh.github.io/pages/2015/05/22/OVS源码分析----datapath消息处理.html">OVS源码分析----datapath消息处理</a></h2>
                <div class="summary"><p></br></p>
<h3>前言</h3>
<p>当packet进入datapath无法匹配则通过netlink上交给用户态，处理完成后用户态会通过generic netlink与内核态进行交互，把流表项flow和packet发给内核态进行处理。下面分析内核态如何通过generic netlink接收flow与packet，并且进行相应处理。</p>
<p>generic netlink：ovs的内核和用户态通过generic netlink(genl，泛型netlink，比netlink支持更多协议，功能更多)交互。genl任然是cs模式，内核为服务端，用户态为客户端（内核中还有一个genl控制器，属于内核态的客户端，用来分配通信通道）。类似socket，genl建立一系列通信通道，genl family对应这些通道，从而交互。</p>
<p>通信前，作为服务端的内核态要定义family（指定信道类型）和operation（处理函数），并且进行注册，则客户端可以通过注册的信息与之交互。直接以ovs内核态为例分析：</p>
<h4><strong>一 内核态对flow的接收与处理</strong></h4>
<p>1 定义注册genl数据结构（datapath\datapth.c）：</p>
<div class="highlight"><pre>static struct genl_family dp_flow_genl_family = {
    .id = GENL_ID_GENERATE,
    .hdrsize ...</pre></div>
                    <a class="btn btn-default btn-xs" href="http://ysywh.github.io/pages/2015/05/22/OVS源码分析----datapath消息处理.html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="http://ysywh.github.io/pages/2015/05/15/OVS源码分析----用户层处理Upcall消息(2).html">OVS源码分析----用户层处理Upcall消息(2)</a></h2>
                <div class="summary"><p></br></p>
<h3>前言</h3>
<p>当OVS内核接从端口到packet，会进行包解析提取出查询key，然后用key进行datapath中的流表匹配处理，对于以下两种情况1）没有匹配到流表项 2）匹配到的流表项动作为发往用户层，都会将packet和
key构造成Upcall消息，通过netlink通道发往用户层，用户态接收upcall消息后会进行处理，比如用户层流表匹配处理等。当然在用户层匹配到流表，会将流表项安装到内核层，达到相同流在内核层快速处理的目的：</p>
<p>上一篇博客分析了用户层从用户层获取upcall消息，对MISS_UPCALL类型消息进行处理并且存入miss（结构体miss_flow）。这篇文章，继续分析对upcall消息的处理、给内核层下发流表项。</p>
<hr />
<p></br>
接下来要具体对miss进行处理（构造facet和对miss执行action）。</p>
<h4>4）<strong><code>static void handle_flow_miss(struct ofproto_dpif *ofproto, struct flow_miss *miss,struct flow_miss_op *ops, size_t *n_ops)</code></strong></h4>
<p><strong>关系</strong>：在handle_miss_upcalls中被调用</p>
<p><strong>功能</strong>：判断是存在和flow相同的facet，不存在则根据实体的结构体ofproto_dpif-&gt;rule和flow_miss-&gt;flow创建facet。存在facet后进而对flow_miss进行处理。</p>
<p>数据结构</p>
<ul>
<li>
<p>facet（ofproto ...</p></li></ul>
                    <a class="btn btn-default btn-xs" href="http://ysywh.github.io/pages/2015/05/15/OVS源码分析----用户层处理Upcall消息(2).html">more ...</a>
                </div>
            </article>
            <hr/>
            <article>
                <h2><a href="http://ysywh.github.io/pages/2015/05/10/OVS源码分析----用户层处理Upcall消息(1).html">OVS源码分析----用户层处理Upcall消息(1)</a></h2>
                <div class="summary"><p></br></p>
<h3>前言</h3>
<p>当OVS内核接从端口到packet，会进行包解析提取出查询key，然后用key进行datapath中的流表匹配处理，对于以下两种情况1）没有匹配到流表项 2）匹配到的流表项动作为发往用户层，都会将packet和
key构造成Upcall消息，通过netlink通道发往用户层，用户态接收upcall消息后会进行处理，比如用户层流表匹配处理等。当然在用户层匹配到流表，会将流表项安装到内核层，达到相同流在内核层快速处理的目的：</p>
<p>下俩将按照用户层接收upcall消息与处理的流程进行分析：</p>
<p>用户层接收upcall消息，通过ofproto实体完成底层消息接收功能的。ofproto是ofproto_dpif类型数据结构，具有数据成员dpif（ofproto\ofproto-dpif.c）。通过ofproto—&gt;dpif与内核交互数据。</p>
<p>upcall处理流程如图:</p>
<p></br></p>
<h4><strong>1）   upcall消息处理函数handle_upcalls(ofproto\ofproto-dpif.c)</strong></h4>
<p><code>static int handle_upcalls(struct ofproto_dpif *ofproto, unsigned int max_batch)</code></p>
<p><strong>功能</strong>：接收upcall消息并对miss_upcall类型消息调用处理。</p>
<p>函数中处理流程如下</p>
<p>1 调用upcall消息接收函数：
    error = dpif_recv(ofproto-&gt;dpif ...</p>
                    <a class="btn btn-default btn-xs" href="http://ysywh.github.io/pages/2015/05/10/OVS源码分析----用户层处理Upcall消息(1).html">more ...</a>
                </div>
            </article>
            <hr/>

        <ul class="pagination">
                <li class="prev disabled"><a href="#">&laquo;</a></li>
                    <li class="active"><a
                            href="http://ysywh.github.io/category/sdn.html">1</a></li>
                    <li class=""><a
                            href="http://ysywh.github.io/category/sdn2.html">2</a></li>
                <li class="next"><a
                        href="http://ysywh.github.io/category/sdn2.html">&raquo;</a></li>
        </ul>
        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/ysywh/"><i class="fa fa-my-github-square fa-lg"></i> my github</a></li>
                <li class="list-group-item"><a href="#"><i class="fa fa-another-social-link-square fa-lg"></i> Another social link</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="http://ysywh.github.io/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                    <li class="list-group-item tag-1">
                        <a href="http://ysywh.github.io/tag/ovs-souce-code.html">
                            OVS souce code
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://ysywh.github.io/tag/mapreduce.html">
                            mapreduce
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://ysywh.github.io/tag/ryu-souce-code.html">
                            RYU souce code
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://ysywh.github.io/tag/shu-ju-jie-gou-suan-fa.html">
                            数据结构，算法
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://ysywh.github.io/tag/letter-count.html">
                            letter count
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://ysywh.github.io/tag/hbase.html">
                            HBase
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://ysywh.github.io/tag/cbench-opendaylight.html">
                            Cbench OpenDaylight
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://ysywh.github.io/tag/mapreduce-shu-ju-jie-gou.html">
                            Mapreduce 数据结构
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://ysywh.github.io/tag/word-count.html">
                            word count
                        </a>
                    </li>
                </ul>
            </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.sdnlab.com/" target="_blank">
                sdnlab
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://www.sdnap.com/" target="_blank">
                sdnap
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://www.muzixing.com/" target="_blank">
                muzixing
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 yansy
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://ysywh.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://ysywh.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://ysywh.github.io/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'ysywhgithubio'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-62970575-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>